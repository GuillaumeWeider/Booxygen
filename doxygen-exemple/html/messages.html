<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gamedev Framework (gf): Game messages</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="gf_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Gamedev Framework (gf)
   &#160;<span id="projectnumber">0.6.0</span>
   </div>
   <div id="projectbrief">A C++11 framework for 2D games</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Game messages </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#messages_intro">Introduction</a></li>
<li class="level1"><a href="#messages_howto">How to define and use messages?</a><ul><li class="level2"><a href="#messages_definition">Defining a message</a></li>
<li class="level2"><a href="#messages_send">Sending a message</a></li>
<li class="level2"><a href="#messages_recv">Receiving a message</a></li>
</ul>
</li>
<li class="level1"><a href="#messages_more">More about gf::MessageManager</a><ul><li class="level2"><a href="#messages_sync">Synchronous delivery</a></li>
<li class="level2"><a href="#messages_remove_handlers">Removing handlers</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="messages_intro"></a>
Introduction</h1>
<p>In any game, you need to pass data around multiple parts of the code. The first choice is to make direct function calls. The main drawback of this approach is the tight <a href="https://en.wikipedia.org/wiki/Coupling_%28computer_programming%29">coupling</a> between the caller and the callee. The second choice is to use the <a href="https://en.wikipedia.org/wiki/Observer_pattern">observer pattern</a>.</p>
<p>The purpose of <a class="el" href="classgf_1_1_message_manager.html" title="A message manager. ">gf::MessageManager</a> is to provide a class that implements the observer pattern.</p>
<h1><a class="anchor" id="messages_howto"></a>
How to define and use messages?</h1>
<p>In this section, we will see how to defined and use messages in your game.</p>
<h2><a class="anchor" id="messages_definition"></a>
Defining a message</h2>
<p>A message is just a structure with your own fields. In gf, a message must derive from <a class="el" href="structgf_1_1_message.html" title="The base class for all messages. ">gf::Message</a> and define a static unique type.</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacegf_1_1literals.html">gf::literals</a>; <span class="comment">// necessary to use _id</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span>HeroPosition : <span class="keyword">public</span> <a class="code" href="structgf_1_1_message.html">gf::Message</a> {</div><div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="group__core.html#ga375ce9d7d861b67c78398d51c1769410">gf::Id</a> type = <span class="stringliteral">&quot;HeroPosition&quot;</span>_id; <span class="comment">// compile-time definition</span></div><div class="line">  <a class="code" href="structgf_1_1_vector.html">gf::Vector2f</a> position;</div><div class="line">};</div></div><!-- fragment --><p> This piece of code defines a message <code>HeroPosition</code> with a single field: <code>position</code>. The type of the message is <code>"HeroPosition"_id</code> that is transformed at compile time in an integer of type <code><a class="el" href="group__core.html#ga375ce9d7d861b67c78398d51c1769410" title="An identifier. ">gf::Id</a></code>.</p>
<h2><a class="anchor" id="messages_send"></a>
Sending a message</h2>
<p>To send a message, you need a <a class="el" href="classgf_1_1_message_manager.html" title="A message manager. ">gf::MessageManager</a>. Here, we suppose we have a global variable called <code>messageManager</code> of this type (see also <a class="el" href="singletons.html">Safe singletons</a>).</p>
<div class="fragment"><div class="line"><a class="code" href="classgf_1_1_message_manager.html">gf::MessageManager</a> messageManager;</div></div><!-- fragment --><p> Then, you only have to call <a class="el" href="classgf_1_1_message_manager.html#ae054f2357236f7ef863607a21c971d5f" title="Send a message. ">gf::MessageManager::sendMessage()</a> with an instance of your message.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>Hero {</div><div class="line"><span class="keyword">public</span>:</div><div class="line"></div><div class="line">  <span class="keywordtype">void</span> update(<span class="keywordtype">float</span> dt) {</div><div class="line">    <span class="comment">// compute new position</span></div><div class="line">    m_position = computeNewPosition(m_position, dt);</div><div class="line"></div><div class="line">    <span class="comment">// broadcast the new position</span></div><div class="line">    HeroPosition message;</div><div class="line">    message.position = m_position;</div><div class="line">    messageManager.<a class="code" href="classgf_1_1_message_manager.html#ae054f2357236f7ef863607a21c971d5f">sendMessage</a>(&amp;message);</div><div class="line">  }</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <a class="code" href="structgf_1_1_vector.html">gf::Vector2f</a> m_position;</div><div class="line">};</div></div><!-- fragment --> <h2><a class="anchor" id="messages_recv"></a>
Receiving a message</h2>
<p>To receive a message, you have to register a message handler in the message manager. A message handler is a function that will be called when a message of a given type is sent. This function can be a free function, or a member function. <a class="el" href="classgf_1_1_message_manager.html" title="A message manager. ">gf::MessageManager</a> provides a shortcut for this last (very comon) case.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>Enemy {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  Enemy() {</div><div class="line">    <span class="comment">// register an handler: the onHeroPosition method</span></div><div class="line">    messageManager.<a class="code" href="classgf_1_1_message_manager.html#a48d349a6546e304542dab9a4d73e184b">registerHandler</a>&lt;HeroPosition&gt;(&amp;Enemy::onHeroPosition, <span class="keyword">this</span>);</div><div class="line">  }</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <a class="code" href="group__game.html#ga3aa6a8e716c96465950e5a16aa3cc7e0">gf::MessageStatus</a> onHeroPosition(<a class="code" href="group__core.html#ga375ce9d7d861b67c78398d51c1769410">gf::Id</a> <span class="keywordtype">id</span>, <a class="code" href="structgf_1_1_message.html">gf::Message</a> *msg) {</div><div class="line">    <span class="comment">// verify that we have the right message type</span></div><div class="line">    assert(<span class="keywordtype">id</span> == HeroPosition::type);</div><div class="line">    <a class="code" href="group__core.html#ga2c8cc7f2cd8231712c90a788692cec61">gf::unused</a>(<span class="keywordtype">id</span>); <span class="comment">// we do not use id after this</span></div><div class="line"></div><div class="line">    <span class="comment">// we can now safely cast the message...</span></div><div class="line">    <span class="keyword">auto</span> heroPosition = <span class="keyword">static_cast&lt;</span>HeroPosition*<span class="keyword">&gt;</span>(msg);</div><div class="line"></div><div class="line">    <span class="comment">// and use its data to update the ennemy</span></div><div class="line">    m_target = heroPosition-&gt;position;</div><div class="line"></div><div class="line">    <span class="comment">// we keep this handler for future messages</span></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__game.html#gga3aa6a8e716c96465950e5a16aa3cc7e0a02bce93bff905887ad2233110bf9c49e">gf::MessageStatus::Keep</a>;</div><div class="line">  }</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <a class="code" href="structgf_1_1_vector.html">gf::Vector2f</a> m_target;</div><div class="line">};</div></div><!-- fragment --> <h1><a class="anchor" id="messages_more"></a>
More about gf::MessageManager</h1>
<h2><a class="anchor" id="messages_sync"></a>
Synchronous delivery</h2>
<p><a class="el" href="classgf_1_1_message_manager.html" title="A message manager. ">gf::MessageManager</a> passes messages <em>synchronously</em>. This means that the message is sent immediately to handlers. An advantage is that there is no need for an allocation, the message can be put on the stack. A drawback is that care must be taken to avoid message loops. If handlers do not send messages, then the drawback disappears.</p>
<h2><a class="anchor" id="messages_remove_handlers"></a>
Removing handlers</h2>
<p>Each message handler receives an handler id when it is registered. This handler id can then be used to remove the handler directly through the <a class="el" href="classgf_1_1_message_manager.html#a87f720ae15a83e95007d03f8880abfcf" title="Remove a handler. ">gf::MessageManager::removeHandler()</a> method.</p>
<p>The other method to remove a handler is to return <a class="el" href="group__game.html#gga3aa6a8e716c96465950e5a16aa3cc7e0a952f8d52fbca6da722e72d520acd6edd">gf::MessageStatus::Die</a> at the end of the handler.</p>
<p>A common error is to register an handler as a method of an object and to delete this object without removing the handler. As a consequence, the message manager will try to call the handler and that will result in an error as the object does not exist anymore. This type of error can be very hard to find because the effect of the error is often indirect.</p>
<p>A good way to prevent this type of error for short life objects is to keep the handler ids and to remove the handlers in the destructor of the class.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>ShortLife {</div><div class="line">  ShortLife() {</div><div class="line">    m_onFoo = messageManager.<a class="code" href="classgf_1_1_message_manager.html#a48d349a6546e304542dab9a4d73e184b">registerHandler</a>&lt;Foo&gt;(&amp;ShortLife::onFoo, <span class="keyword">this</span>);</div><div class="line">    <span class="comment">// register the same function for two message types: that makes two different handlers</span></div><div class="line">    m_onBar = messageManager.<a class="code" href="classgf_1_1_message_manager.html#a48d349a6546e304542dab9a4d73e184b">registerHandler</a>&lt;Bar&gt;(&amp;ShortLife::onBarOrBaz, <span class="keyword">this</span>);</div><div class="line">    m_onBaz = messageManager.<a class="code" href="classgf_1_1_message_manager.html#a48d349a6546e304542dab9a4d73e184b">registerHandler</a>&lt;Baz&gt;(&amp;ShortLife::onBarOrBaz, <span class="keyword">this</span>);</div><div class="line">  }</div><div class="line"></div><div class="line">  ~ShortLife() {</div><div class="line">    messageManager.<a class="code" href="classgf_1_1_message_manager.html#af15bb3fab26df9b0abd005e40d96626c">removeHandlers</a>({ m_onFoo, m_onBar, m_onBaz });</div><div class="line">  }</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <a class="code" href="group__game.html#ga3aa6a8e716c96465950e5a16aa3cc7e0">gf::MessageStatus</a> onFoo(<a class="code" href="group__core.html#ga375ce9d7d861b67c78398d51c1769410">gf::Id</a> <span class="keywordtype">id</span>, <a class="code" href="structgf_1_1_message.html">gf::Message</a> *msg) {</div><div class="line">    <span class="comment">// do something useful</span></div><div class="line">    doSomethingUsefulWith(<span class="keywordtype">id</span>, msg);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__game.html#gga3aa6a8e716c96465950e5a16aa3cc7e0a02bce93bff905887ad2233110bf9c49e">gf::MessageStatus::Keep</a>;</div><div class="line">  }</div><div class="line"></div><div class="line">  <a class="code" href="group__game.html#ga3aa6a8e716c96465950e5a16aa3cc7e0">gf::MessageStatus</a> onBarOrBaz(<a class="code" href="group__core.html#ga375ce9d7d861b67c78398d51c1769410">gf::Id</a> <span class="keywordtype">id</span>, <a class="code" href="structgf_1_1_message.html">gf::Message</a> *msg) {</div><div class="line">    <span class="comment">// do something useful</span></div><div class="line">    doSomethingUsefulWith(<span class="keywordtype">id</span>, msg);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__game.html#gga3aa6a8e716c96465950e5a16aa3cc7e0a02bce93bff905887ad2233110bf9c49e">gf::MessageStatus::Keep</a>;</div><div class="line">  }</div><div class="line"></div><div class="line">  <a class="code" href="group__game.html#ga6c620c63dd07ac6064f87f0ddafd1e87">gf::MessageHandlerId</a> m_onFoo, m_onBar, m_onBaz;</div><div class="line">};</div></div><!-- fragment --></div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
